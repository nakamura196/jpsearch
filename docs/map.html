<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Map search in Japan Search</title>
  <!-- Bootstrap core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.4/css/mdb.min.css" rel="stylesheet">
  <script src="//code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-light white scrolling-navbar">
      <div class="container">
        <a class="navbar-brand">Map search in Japan Search</a>
      </div>
    </nav>
    <!--/.Navbar-->
  </header>
  <div class="container mt-5">
    <div id="mapid" style="width: 100%; height: 600px;" class="mt-5"></div>
  </div>
  <footer class="page-footer text-center font-small mdb-color darken-2 mt-5 fadeIn">
    <!--Copyright-->
    <div class="footer-copyright py-5">
      <a href="https://researchmap.jp/nakamura.satoru/?lang=english">Satoru Nakamura</a>.
    </div>
    <!--/.Copyright-->
  </footer>
  <!--/.Footer-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  <link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css">
  <script src="https://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
  <script src="https://leaflet.github.io/Leaflet.markercluster/example/realworld.388.js"></script>
  <script>

  jQuery(document).ready(function() {
    showMap();
  });

  function showMap(){

    var mymap = L.map('mapid').setView([51.505, -0.09], 2);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      maxZoom: 10,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
      '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery &#169; <a href="http://mapbox.com">Mapbox</a>',
      id: 'mapbox.streets'
    }).addTo(mymap);


    var query = " SELECT DISTINCT ?s ?label ?lat ?long ";
    query += " WHERE { ";
    query += " ?s <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://jpsearch.go.jp/term/type/Place> . ";
    query += " ?s <http://schema.org/geo> ?geo . ";
    query += " ?s <http://www.w3.org/2000/01/rdf-schema#label> ?label . ";
    query += " ?geo <http://schema.org/latitude> ?lat . ";
    query += " ?geo <http://schema.org/longitude> ?long .  ";
    query += " ?item <http://schema.org/spatial> ?s .  ";
    query += " } ";

    $.ajax({
      url:"https://jpsearch.go.jp/rdf/sparql",
      type:'GET',
      data:{
        query : query,
        format : "json"
      }
    })
    // Ajaxリクエストが成功した時発動
    .done( (data) => {

      var result = data.results.bindings;

      var markers = L.markerClusterGroup();

      var items = new Array();

      var mlat = 0;
      var mlong = 0;

      var set = new Array()

      for (var i = 0; i < result.length; i++) {
        var obj = result[i];
        var s = obj.s.value
        var title = obj.label.value
        var url = "https://jpsearch.go.jp/rdf/sparql/?default-graph-uri=&query=select+distinct+%3Flabel+%3FjapanSearchLink+%3Fprovider+%0D%0Awhere+%7B%0D%0A%3Fs+%3Chttp%3A%2F%2Fschema.org%2Fspatial%3E+%3C"+s+"%3E+.++%0D%0A%3Fs+%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23label%3E+%3Flabel.+%0D%0A%3Fs+%3Chttps%3A%2F%2Fjpsearch.go.jp%2Fterm%2Fproperty%23sourceInfo%3E+%3FsourceInfo+.++%0D%0A%3FsourceInfo++%3Chttp%3A%2F%2Fschema.org%2FrelatedLink%3E+%3FjapanSearchLink+.+%0D%0A%3FsourceInfo++%3Chttp%3A%2F%2Fschema.org%2Fprovider%3E+%3Fp+.+%0D%0A%3Fp+%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23label%3E+%3Fprovider+.+%0D%0A%7D"
        var marker = L.marker(new L.LatLng(obj.lat.value, obj.long.value), { title: title });

        mlat += Number(obj.lat.value);
        mlong += Number(obj.long.value);

        var contents = '<div>';
        contents += '<h5 class="mt-0"><a href="'+url+'" target="_blank">'+title+'</a></h5>';
        contents += '</div>';

        marker.bindPopup(contents);
        markers.addLayer(marker);
      }

      mymap.addLayer(markers);

      var popup = L.popup();

      function onMapClick(e) {
        popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);
      }

      mymap.on('click', onMapClick);

      mymap.panTo(new L.LatLng(mlat / result.length, mlong / result.length));

    })
    // Ajaxリクエストが失敗した時発動
    .fail( (data) => {
      alert(data.statusText);
    })
    // Ajaxリクエストが成功・失敗どちらでも発動
    .always( (data) => {

    });
  }


  </script>
</body>
</html>
